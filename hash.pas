unit hash;

interface
 uses params,Board,move;
TYPE
   TPieseZobr = array[BlackKing..WhiteKing,a1..h8] of Tkey;
   TPawnZobr = array[white..black,a1..h8] of TPawnKey;
   TMatZobr = array[BlackQueen..WhiteQueen,0..10] of TMatKey;
   TCastleZobr = array[0..15] of Tkey;
   Tentry = record
              Key:Tkey;
              data1 : integer; // 0..15  - move
                               // 16..31 - value
              data2 : integer; // 0..4   - Age
                               // 5..7 - Type
                               // 8..15  - Depth
                               // 16..31 - StaticEval
            end;
   TTT = array of TEntry;
CONST
    PieseZobr : TpieseZobr =
(($5021FF5CD13A2ED5,$2A649C6EBCFD50FC,$09D1BC9A3DD90A94,$39BC6C87167C33E7,$6C16CA8AEA98AD76,$3B6E2924F03912EA,$2366E5B8C54F48B8,$4F80F7A035DAFB04,
$4A750A09CE9573F7,$56436C9FE1A1AA8D,$1BEDE3A3AEF53302,$2D255069F0B7DAB3,$4DC4DE189B671A1C,$4850E73E03EB6064,$78E37644E7CAD29E,$22F61BB6E437FDB5,
$7A1EE967D27579E2,$722FF175F572C348,$30183DB56FFC6A79,$2CD16E2ABD791E33,$364F6FFA464EE52E,$7A13F18BBEDC4FF5,$48C93882F9475F5F,$4D454F8F19C5126A,
$28D7E4DAB780A08D,$1DD01AAFCD53486A,$64972D68DEE33360,$63E22C147B9C3403,$7A76956C3EAFB413,$2B9090168DD05F34,$3559EB1D04E5E932,$1D266D6A1CC0542C,
$1D1D84FCCE371425,$26E6DB8FFDF5ADFE,$4A1E3785A9E724E5,$6DB454E7BADC0805,$36F60E2BA4FA6800,$259E0BD101731A28,$03219A39EE587A30,$523C8E176D113600,
$0647DFEDCD894A29,$3F84470805E69B5F,$61CF4F94C97DF93D,$34D8F77BC3E56167,$720BF5F26F4D2EAA,$583CC2687A19255F,$1338E69C052B8E7B,$31865CED6120F37D,
$049A7F41061A9E60,$5E90277E7CB39E2D,$09C350C893AE7DC1,$51E649DE1E7F268B,$4659D2B743848A2C,$13AE978D09FE5557,$07A69AFDCC42261A,$222BBFAE61725606,
$579476A84EE20D06,$150F361DAB9DEC26,$56986E2EF3ED091B,$77C621CC9FB3A483,$2F7043154CF2BC7D,$195075C5B8CBADA7,$2457B45F9335B8F1,$3394FD6846D3A0CB
),($1A083822CEAFE02D,$331478F3AF51BBE6,$03488B95B0F1850F,$3253A729B9BA3DDE,$13C5B5F47356388B,$5ABF2AC8201752FC,$79B89D3E99A075C2,$1E1032911FA78984,
$05A7E8A57DB91B77,$70EB093B15B290CC,$008BD68E6AC10365,$45CC1D89724FA456,$1DA4243DE836994F,$0BF692B38D079F23,$6703DF9D2924E97E,$336F52F8FF4728E7,
$0CFFA9412EB642C1,$52AB92BEB9613989,$081B82A13B51B9E2,$7F9B6AF1EBF78BAF,$7943AEE7FEBF21B8,$3422061193D6F6A7,$47D9F16864A76E94,$693501D628297551,
$4330DE426430F69D,$785B2B4FBCDE44B7,$2DE0966DAF2F8B1C,$029626E3892D95D7,$12153635B2C0CF57,$36833336D068F707,$2F08DA9177DDA93D,$74C04BF1790C0EFE,
$5E68A2355B93CAE6,$2C5E9DEB57EF4743,$5FEA21EA9E7557E3,$66C1A2A1A60CD889,$74F5D05C10CAB243,$2B4F6451CC1D45EC,$004456AF10F5FB53,$33598080CE64A656,
$7FBA195410E5CA30,$70CB6AF7C2D5BCF0,$539BB9C3A48DB6CF,$24EC0132764CA04B,$6328E230E3E2B3FB,$57277707199B8175,$7C45D833AFF07862,$32AB0EDB696703D3,
$63273522064480CA,$634A1D250E7A8D6B,$190E714FADA5156E,$4AE7D6A36EB5DBCB,$4E9D2827355FC492,$7A4C10EC2158C4A6,$2102AE466EBB1148,$177E00F9FC32F791,
$7EBA726D8C94094B,$2785338347F2BA08,$01A1549FD6573DA5,$4F3145DE0ADD4289,$61B32AA868338AE9,$400F3B30F32F543C,$10AF9B4B85ACFD63,$268A9649E9579A1B
),($683A908FF2FB60CA,$02C7709E781EB7CC,$14A68FD73C910841,$5C82C505DB9AB0FA,$5F0F4A5898171BB6,$14ACBAF4777D5776,$1A85AC909A24EAA1,$390E5FB44D01144B,
$7B32F7D1E03680EC,$043FCAE60CC0EBA0,$22FE545401165F1C,$10CFF333E0ED804A,$11379625747D5AF3,$57288E012AEB8D31,$1C684CB6C4D24417,$57F4F2448C0CEB81,
$4C0563B89F495AC3,$5941ACA44B20A45B,$742E1E651C60BA83,$19E7AFEABE000731,$549503536ABCA345,$65D34954DAF3CEBD,$5873DB391292ED4F,$1255ABB50D532280,
$098954D51FFF6580,$3E2B8BCBF016D66D,$54DBA84729AF48AD,$79999CDFF70902CB,$5544F7D774B14AEF,$5A3A361B1C5157B1,$1FFF7AC80904BF45,$0A8E849EB32781A5,
$14EBC8ABCFB56DAE,$764DBEAE7FA4F3A6,$7A7E393983325753,$298AF231C85BAFAB,$1DDC0325259B27DE,$2472F6207C2D0484,$7C0828DD624EC390,$22853B80F17F58EE,
$241260ED4AD1E87D,$29AA4D20DB084E9B,$21082C0466DF6C0A,$106F72FE81E2C590,$08DD9BDFD96B9F63,$40C0F5A60EF4CDCF,$6AD047C430A12104,$6DC93D9526A50E68,
$6BFA9AAE5EC05779,$1BDEA12E35F6A8C9,$11B534F885818A06,$0A804D18B7097475,$46C9FEB55D120902,$4F05DAF5AC8D77B0,$310CB380DB6F7503,$1C2ED44081CE5FBD,
$5586BD01C5C217F6,$4E2F8642CA0712DC,$6728E8C83C334074,$003A93D8B2806962,$551FFF9FA941B218,$763F1C2E494AFE4D,$443AE63C0154137C,$777E7D97520C11BB
),($3290AC3A203001BF,$7449BBFF801FED0B,$24AA6C514DA27500,$1F74D14F7454A824,$6D2BDCDAE2919661,$0249A47AEE0E41F7,$72B12C32127FED2B,$1C1633264DB49C89,
$5FD395339CDBF4A7,$17D7374C60087B73,$5D2C5BC84BC8D8FC,$3415938D7DA94E3C,$52593803DFF1E840,$763C4A1371B368FD,$79B5B7C4ACC67C96,$52B7ADEEDED1F73F,
$7CAF55C1BF8A4424,$513E5E634C70E331,$284C847B9D887AAE,$2865A54EDCC0F019,$157BAF61700CFF4E,$3AC7A9A18531294B,$565C31F7DE89EA27,$69F6082B05542E4E,
$052F54934DA55CC9,$1725CABFCB045B00,$694C39A54A98307F,$7B77497B32503B12,$67F28ECD2D49EECD,$5D0A12F27AD310D1,$3FCED1B0048EAC50,$2319CE15B0B4DB31,
$72C8834A5957B511,$1A8C1E992B941148,$0FE88B57305E2AB6,$734DE8181F6EC39A,$57504DFA8816EDBB,$54347F66EC8941C3,$2EAB8CA63CE802D7,$001F837CC7350524,
$4A672B91E9E4FA16,$6FED53D75FD64E6B,$7C87614BAF287E07,$7D080D236DA814BA,$5DF957BC36D8B9CA,$6846963877671A17,$144F6DE09134DFB6,$1C1169FA2777B874,
$3550C2321FD6109C,$3A88A0FBBCB05C63,$54C718BC4AE8AE5F,$24B33C9D7ED25117,$30C05B1BA332F41C,$1853EAB63B5E0B35,$5AF8E9829FE96B5F,$705D129681949A4C,
$24C0E332B70019B0,$42B5A03F71471A6F,$71F1CE2490D20B07,$70CC73D90BC26E24,$7BAE0A4CB2583256,$717C91D21427860A,$2E1ECD285D5A3E7E,$74D1BD329C0E30AB
),($1C15F73E62A76AE2,$05D1A1AE85B49AA1,$7B0500AC42047AC4,$5310A7C2CE9B6555,$16D693460CC37E5D,$19FC8A768CF4B6D4,$0535F040B9744FF1,$7F07F64EF8ED14D0,
$1881AFC9A3A701D6,$799E81F05BC93F31,$7F6712FFCFD75EA1,$5ED2D633CAD004F6,$2EF3AF4A563DFE43,$21A007933A522A20,$6755178D58FC4E76,$5F1D9F9D784BA010,
$73A678CAD9A2E38C,$290B24499FCFAFB1,$0CD9A497658A5698,$5AB9FE6525D89021,$501F65EDB3034D07,$565601C0364E3228,$325928EE6E6F8794,$303031A8B4516E84,
$69F6760E32CD8021,$11317BA87905E790,$3BDBB92C43B17F26,$6CED1983376FA72B,$1FF38FED72E9052F,$4DA8979A0041E8A9,$1B3CDB65F82CA382,$67378D8ECCEF96CB,
$1E152328F3318DEA,$604D51B25FBF70E2,$1BFB227EBDF4C5CE,$1761F93A44D5AEFE,$261E4E4C0A333A9D,$0B889D624D44885D,$58EFC10B06A2068D,$54490AD526F14431,
$795CFFA23AF5F6F4,$22EBEE47E2FBFCE1,$3F8D5108E27E0D48,$60E8ED72C0DFF5D1,$1A4E4822EB4D7A59,$660D3257380841EE,$52E762596BF68235,$5E0C89A556B9AE70,
$743C732873F24C13,$230E343DFBA08D33,$10E8B35AF3EEAB37,$3B544EBE544C19F9,$1A4FF12616EEFC89,$47F6AA2DE59AEA61,$3862225B055B6960,$162ACEEFA82E1C84,
$64D9429322CD065A,$65FA4F227A2B6D79,$0A9C32D5EAE45305,$257E6339DD2CF3A0,$22E2B3255597DAB5,$02CE33625AC66F20,$678D11E5357B18B5,$35D20752212F554A
),($2AF7398005AAA5C7,$5DB4832046F3D9E5,$19F3C751D3E92AE1,$18727070F1BD400B,$6568FCA92C76A243,$5093417AA8A7ED5E,$699D662AF4243939,$07BF02C6B49E2AE9,
$5B9B63EB9CEFF80C,$3C79A0FF5580EF7F,$45F20042F24F1768,$287832D392EFEE56,$2F2042F5CC5C2858,$346EE9C5E64A6E7C,$1AE182C8BC9474E8,$1315E5EB3A129ACE,
$16B9F7E06C453A21,$32095B6D4AB5F9B1,$04208FE9E8F7F2D6,$7678647E3519AC6E,$1A804AADB9CFA741,$16F50EDF91E513AF,$19170A5DC3115544,$0FD22063EDC29FCA,
$3A89142E007503B8,$68D9ECBE2CF3D73F,$18A6A990C8B35EBD,$52733C4335C6A72F,$0981DCD296A8736D,$7B4A38E32537DF62,$10DCD78E3851A492,$73B8B6675A6507FF,
$56BF7BAEE43CAC40,$65CA5B96B7552210,$3F6C6AF859D80055,$4ED0FE7E9DC91335,$66B4835D9EAFEA22,$2F0C317D32ADAA8A,$0B090A7560A968E3,$5B45E522E4B1B4EF,
$3B097ADAF088F94E,$1DB956E450275779,$3925A6CD0421AFF3,$159F587D507A8359,$530C088BA61EA5EF,$4112CF68649A260E,$35635C95FF7296E2,$6B17B224BAD6BF27,
$369E38A8965C6B65,$0F9887E6078735A1,$3FA9DDFB67E2F199,$7B152FE3FF26DA89,$04547DDC3E203C94,$5A0F544DD2B1FB18,$7F577222C14F0A3A,$1AF3DBE25D8F45DA,
$0AF38731C02BA980,$1D95B0A5FCF90BC6,$142DE49FFF7A7C3D,$31D71DCE64B2C310,$5557ACC65E78761B,$11228D7655A3DA89,$5BECF05E7D7BCA2D,$78EA4DE922FC2D8D
),($40BDF15D4A672E32,$0DBD98A352AFD40B,$3575668334A1DD3B,$7EF48F2B83024E20,$5355F900C2A82DC7,$0CE26C0B95C980D9,$2E4A9346CC3F7CF2,$6304D09A0B3738C4,
$4F464CEC899A2F8A,$6FAC4B70633B8F81,$43539603D6C55602,$1BC5A38EF729ABD4,$51039AB7712457C3,$4FC447F1E53C8E1B,$7E9A44E9362F05FA,$4F2A5CB07F6A35B3,
$1D1D60E5076F5B6F,$1D1260A51107FE97,$0ED9B915C66ED37E,$5363EFF5F0977996,$560F6DCEDC314222,$3C4097B116C524D2,$3A9BF55BA91F81CA,$3BE83F4ECC2BDECB,
$0572B974F03CE0BB,$1FCA8A92FD719F85,$14628D38D0C20584,$4678B6D860284A1C,$3D5774A11D31AB39,$43954B3252DC25E5,$437B45B3F8D6F2BA,$7440FB816508C4FE,
$51D2B1AB2DDFB636,$469356C504EC9F9D,$1CFC8BED0D681639,$50B704CAB602C329,$6B3593803173E0CE,$116D0016CB948F09,$49787FEF17AF9924,$1BDA0492E7E4586E,
$63573FF03E224774,$14C3251F06F90CF3,$1B6BACA2AE4E125B,$1E21F4F903B33FD9,$30774D261CC609DB,$4A29C6465A314CD1,$455A4B4CFE30E3F5,$67FEF95D92607890,
$7CB6BE43A9F2FE9B,$2C046F22062DC67D,$2C042E70F8B383F2,$0A328A1CEDFE552C,$163EF2C96B33BE31,$730499AF921549FF,$44C118BFE78FEAAE,$486289DDCC3D6780,
$1E4C1269BAA4BF37,$1F6A419D382595F4,$117F1DD5F8886C61,$67A34DAC4356550B,$69262FC474850311,$5D377D6DB6FF2011,$21266DF0548EB860,$27367E9108810C10
),($1D39247E33776D41,$011355146FD56395,$07D2074B81D79217,$735E2B97A4C45A23,$11D505D4C351BD7F,$07FB9F855A997142,$249CD132BFBF7CC4,$1920C04D47267BBD,
$2171E64683023A08,$7538639CE705B824,$3B215798D45DF7AF,$2A969B5C691CCB7A,$6F2F054308F6A2BC,$407A3F80C31FB4B4,$305CA3F564268D99,$08BD35CC38336615,
$07D380BDA5BF7859,$3810E399B6F65BA2,$7A249A57EC0C9BA2,$5E11E86D5873D484,$0CE2A38C344A6EED,$56963B0DCA418FC0,$59B97885E2F2EA28,$59A11FBB3D9808E4,
$5C842B7E2819E230,$357D2E985E1419C7,$7C7C95D827357AFA,$5BC0D2B6AB90A559,$5873888850659AE7,$0A1B083821F40CB4,$3438C2B67F98E5E9,$43A9DC228CAAC9E9,
$13328503DF48229F,$2FD7E4B9E72CD38C,$48763C5B08D1908C,$518D8549D140CAEA,$4CC317FB9CDDD023,$1C4CD6257C5A3603,$2CF9C8CA052F6E9F,$21E9300CD8520548,
$21E0BD5026C619BF,$4FC8E9560F91B123,$3E003E616A6591E9,$758F450C88572E0B,$1D765E419FB69F6D,$443F64EC5A371195,$6D2DF21216235097,$6B02E63195AD0CF8,
$1F2B1D1F15F6DC9C,$08DE8A1C7797DA9B,$310BB459132D0A26,$349B52E587A1EE60,$07A3AEC79624C7DA,$74F85198B05A2E7D,$4E4B705B92903BA4,$79F4892ED96BD438,
$7DC7785B8EFDFC80,$17EFEE45B0DEE640,$64A53DC924FE7AC9,$520D8C88C8FFE65F,$17E72B072F8E9756,$0E652D1B7BC96113,$0F84AA0AB71E2426,$46549B3743E4A19E
),($44DB015024623547,$239F8B2D7FF719CC,$34AB30F062B19ABF,$1FCBACD259BF02E7,$4DE0B0F40F32A7B8,$7BCBC38DA25A7F3C,$27E6AD7891165C3F,$092237AC237F3859,
$506AACF489889342,$6DE6C87F8477609D,$130F80F4E8EB7462,$65942C7B3C7E11AE,$480412BAB7F5BE2A,$33819A42ABE61C87,$24FC4BD4FC5558CA,$14061B871E04DF75,
$7BA2484C8A0FD54E,$35CAB62109DD038A,$5A110C6058B920A0,$1B85D488D0F20CC5,$107F30421D78C5DE,$6F1955914B609F93,$6F423357E7C6A9F9,$33F256D8ACA0B0B9,
$23BC941D0A5061CB,$2FE4B17170E59750,$4CCB7005C6B9C28D,$7E75D99D94A70F4D,$1F65789A6509A440,$150113646D1D6E03,$5BC27AB5447822BF,$1FC477DE4ED681DA,
$4838D65F6EF6748F,$5D69A0D8AB3B546D,$7F7CC39420A3A545,$64DBF0634473F5D2,$219B97E26FFC81BD,$258E5A80C7204C4B,$2BEEDDB2DDE06FF1,$349C3B3995091A36,
$0D14DEDB30BE846E,$38D91274B9E9D4FB,$61BDD1307C66E300,$3063E962E045F54D,$5D94337FBFAF7F5B,$5813F2FAB7F5C5CA,$22AF003AB672E811,$51E0CCD25BB9C169,
$2A9119FF184CCCF4,$35B4071DBFC73A66,$0E09B88E1914F7AF,$3E666E6F69AE2C15,$190A98FD5071D263,$03727073C2E134B1,$55B6344CF97AAFAE,$75B4B0B0D2DEEEB4,
$1FAB64EA29A2DDF7,$13CBE0B699C2585D,$0C335248857FA9E7,$7165B587DF898190,$2764ECCBE96ECFB2,$37AE15B14D0FEAA1,$07AB01113585DAAB,$5B3EDDE1A13A5AE7
),($75834465489C0C89,$679F848F6E8FC971,$49452CA81A09D85D,$3F983FE0FE5D8244,$42E240CB63689F2F,$637A7780DECFC0D9,$54B3F4FA5F40D873,$0DE8DCA9F03CC54E,
$6503080440750644,$06536B8CF3428A8C,$2E623FD67468AA70,$21F08570F420E565,$19AFE59AE451497F,$2DF16F761598AA4F,$69B97DB1A4C03DFE,$3BBA57B68871B59D,
$39B0BF7DDE437BA2,$77A225A07CC2C6BD,$56FD23C8F9715A4C,$0D151D86ADB73615,$37624AE5A48FA6E9,$6CB53939887E8175,$50E4366228B03343,$35DD37D5871448AF,
$09C7E552BC76492F,$7FBF21EC8A1F45EC,$2A70B5B4F89695A2,$17FCAACBF030BC24,$6479EE5B9930578C,$3BC36E078F7515D7,$367B7896167B4C84,$6DD856D94D259236,
$0F8419A348F296BF,$73AA8A564FB7AC9E,$09039D79D6FC5C5C,$53898E4C3910DA55,$1FE2CCA76517DB90,$74D14597E660F855,$46E57A78FBD986E0,$12A8F216AF9418C2,
$3871700761B3F743,$59F1F30CCD97FB09,$240AB57A8B888B20,$7B64978555326F9F,$6FFE73E81B637FB3,$59AC2C7873F910A3,$1AEBA33AC6ECC6B0,$50065E535A213CF6,
$7B4A3D794A9A80D2,$43ED7F5A0FAE657D,$1EEDECA8E272B933,$6805A1E290CF2456,$76F7FD1431714200,$352787BAA0D7C22F,$4AC09AFBDDD2CDB4,$046E3ECAAF453CE9,
$1DA058C67844F20C,$55F9E858292504D5,$66C42178C4BBB92E,$1EF6E6DBB1961EC9,$40B32EE44795C6C3,$78D9B035FB5D8A14,$5CDB0D6E3BB98961,$265FEAEC1AFDA596
),($0FBBAD1F61042279,$7D11CDB1C3B7ADF0,$4C9F34427501B447,$51EBDC4AB9BA3035,$42880B0236E4D951,$79AD695501E7D1E8,$6E954D3C7B411F47,$33F22C3D0B0B38ED,
$6F927DBCF00C20F2,$2246637CFF328532,$7EED120D54CF2DD9,$11B859E59ECB6350,$74F076E65F2CE6F0,$7793C46702E086A0,$7C6A82D64B8655FB,$77A255D83BC373F8,
$18FCF680573FA594,$4361C0CA3F692F12,$04FEABFBBDB619CB,$13C42566AEF98FFB,$3A6C27934E31188A,$3344C470397BBA52,$30F5611484119414,$6BFAFA33D7254B59,
$0107FCCF064FCF56,$164E915CD5E2B207,$37A0B174CFF6F36E,$0547EDDFB81CCB94,$56C074A581EA17FE,$7F9D1A2E1EBE1327,$29119B60369FFEBD,$073973751F12DD5E,
$57A023A73260B45C,$2AC40A2703D9BEA0,$209E8C8C35AB96DE,$2680B122BAA28D97,$39571FA04DC089C8,$6699ED85B0DFB40D,$14A195640116F336,$1877B51E57A764D5,
$64C8E531BFF53B55,$2E6D02C36017F67F,$6F02CDD06FFDB432,$0C90FD9B083F4558,$64D0E29EEA8838B3,$13B633ABFA3469F8,$6C47BEC883A7DE39,$78EDEFD694AF1EED,
$371F77E76BB8417E,$21874B8B4D2DBC4F,$01536D601170FC20,$674733427B72F0C1,$0D2636B81555A786,$2BBDCDD7ED5C0860,$35FDFC5D3132C498,$164781CE734B3C84,
$233003B5A6CFE6AD,$59300222B4561E00,$71BCC3D275AFE51A,$621A6B35DF0C3AD7,$73EEC81180A47ECB,$2867CAB88BC9AF48,$59C229B1FB6FD0D8,$0134AFE791A71E87
),($0D7E765D58755C10,$73218F1C9510786C,$271B9B83461CBD93,$7CF7FE8A3430B241,$39F890F579F92F88,$7145B6BECCDEA195,$70AC4CD9F04F21F5,$5BFEA5B4712768E9,
$39FD7620E7316243,$120E449535DD359E,$491800E98FB99929,$28AED140BE0BB7DD,$3CE5D2248682C115,$5E336A2A4BC1C44B,$0EC97D2917456ED0,$595BE88CD210FFA7,
$40E087931A00930D,$528F7C8602C5807B,$1A9632E65904AD3C,$48CBFF086DDF285A,$088E049589C432E0,$34B81B3FA97511E2,$7BD94E1D8E17DEBC,$39AB4CE57F2D34F3,
$23B70EDB1955C4BF,$3E7444E39328A0AC,$2E18BC1AD9704A68,$4FFE1939438E9B24,$7B3F0195FC6F290F,$5CDD7D20903D0C25,$2C12FB171817EEE7,$61925C71285279F5,
$1FC10D0F989993E0,$1E99B96E70A9BE8B,$56B6D0ECC617C699,$7983EED3740847D5,$4F3F4688801EB9AA,$42A1E7B5B459AEB5,$574BBE77E6116AC7,$193E1DE72D36D310,
$106C09B972D2E822,$364BE8D8B25396C1,$0215E577001332C8,$7976033A39F7D952,$087E79E5A57D1D13,$4AF21ECD4377B28C,$25B1CFDBA0AB4067,$6E97F453F06791ED,
$4D04F3FF001A4778,$53C065C6C8E63528,$6C8177F83F900978,$57E3306D881EDB4F,$4CEC0A73B49C9921,$49CAD48CEBF4A71E,$687FBB46217A360E,$522E23F3925E319E,
$5E5637885F29BC2B,$7CA9723FBB2E8988,$16FBF83A12884624,$1C99DED33CB890A1,$091508AF2FA889F5,$48001E8CDDD27712,$37250C7121ECBDF4,$14977B441DC72BEF
),($1605D5F0E25EC3B0,$4BB38DE5E7219443,$637B2B34FF93C040,$0C74C368081B3075,$63DC359D8D231B78,$24C3C94DF9C8D3F6,$07B3E2B2B5C907B1,$1A74ACB964E78CB3,
$35889C6E15630A75,$73A1921916591CBD,$5EC468145B7605F6,$5648F680F11A2741,$066F70B33FE09017,$2C604A7A177326B3,$4547F57E42A7444E,$274049DAC312AC71,
$68CA39053261169F,$1D1DFA2EFC557F73,$506E6744CD974924,$58627E1A149BBA21,$6C3B8E3E336139D3,$071582401C38434D,$147AE053EE56E63C,$462C58F97DD949BF,
$4715ED43E8A45C0A,$49353FEA39BA63B1,$39C11D5B1E43A07E,$12FAE24291F2B3F1,$7F5126DBBA5E0CA7,$4E68341F79893389,$1B0CAB936E65C744,$4DDA48153C94938A,
$244CFE79AE538BBE,$3A938FEE32D29981,$367C1FA481680AF8,$1E17E49642A3E4C1,$38B6525C21A42B0E,$63767572AE3D6174,$6BE9EA2ADF4321C7,$252F59CF0D9F04BB,
$7884D9BC6CB569D8,$18F076A4F7A2322E,$2738259634305C14,$733EA705FAE4FA77,$1C2559E30F0946BE,$506C11B9D90E8B1D,$5092EF950A16DA0B,$3A6853C7E70757A7,
$1F91508BFFCFC14A,$56B04D3B7651DD7E,$3592BF39B0364963,$2D8D5432157064C8,$19EBB029435DCB0F,$59E92AA246BF719E,$78549E1A3AA5E00D,$2BC60A63A6F3B3F2,
$0A56A5F0BFE39272,$461BB3A141E50E8C,$5FA7867CAF35E149,$50E4427A5514FB72,$6C9938731A864401,$466EFF70A285AA00,$4D43B710F78AABEB,$301DD855A5F141FE));

    PawnZobr : TPawnZobr =
(($5021FF5CD13A2ED5,$2A649C6EBCFD50FC,$09D1BC9A3DD90A94,$39BC6C87167C33E7,$6C16CA8AEA98AD76,$3B6E2924F03912EA,$2366E5B8C54F48B8,$4F80F7A035DAFB04,
$4A750A09CE9573F7,$56436C9FE1A1AA8D,$1BEDE3A3AEF53302,$2D255069F0B7DAB3,$4DC4DE189B671A1C,$4850E73E03EB6064,$78E37644E7CAD29E,$22F61BB6E437FDB5,
$7A1EE967D27579E2,$722FF175F572C348,$30183DB56FFC6A79,$2CD16E2ABD791E33,$364F6FFA464EE52E,$7A13F18BBEDC4FF5,$48C93882F9475F5F,$4D454F8F19C5126A,
$28D7E4DAB780A08D,$1DD01AAFCD53486A,$64972D68DEE33360,$63E22C147B9C3403,$7A76956C3EAFB413,$2B9090168DD05F34,$3559EB1D04E5E932,$1D266D6A1CC0542C,
$1D1D84FCCE371425,$26E6DB8FFDF5ADFE,$4A1E3785A9E724E5,$6DB454E7BADC0805,$36F60E2BA4FA6800,$259E0BD101731A28,$03219A39EE587A30,$523C8E176D113600,
$0647DFEDCD894A29,$3F84470805E69B5F,$61CF4F94C97DF93D,$34D8F77BC3E56167,$720BF5F26F4D2EAA,$583CC2687A19255F,$1338E69C052B8E7B,$31865CED6120F37D,
$049A7F41061A9E60,$5E90277E7CB39E2D,$09C350C893AE7DC1,$51E649DE1E7F268B,$4659D2B743848A2C,$13AE978D09FE5557,$07A69AFDCC42261A,$222BBFAE61725606,
$579476A84EE20D06,$150F361DAB9DEC26,$56986E2EF3ED091B,$77C621CC9FB3A483,$2F7043154CF2BC7D,$195075C5B8CBADA7,$2457B45F9335B8F1,$3394FD6846D3A0CB
),($1A083822CEAFE02D,$331478F3AF51BBE6,$03488B95B0F1850F,$3253A729B9BA3DDE,$13C5B5F47356388B,$5ABF2AC8201752FC,$79B89D3E99A075C2,$1E1032911FA78984,
$05A7E8A57DB91B77,$70EB093B15B290CC,$008BD68E6AC10365,$45CC1D89724FA456,$1DA4243DE836994F,$0BF692B38D079F23,$6703DF9D2924E97E,$336F52F8FF4728E7,
$0CFFA9412EB642C1,$52AB92BEB9613989,$081B82A13B51B9E2,$7F9B6AF1EBF78BAF,$7943AEE7FEBF21B8,$3422061193D6F6A7,$47D9F16864A76E94,$693501D628297551,
$4330DE426430F69D,$785B2B4FBCDE44B7,$2DE0966DAF2F8B1C,$029626E3892D95D7,$12153635B2C0CF57,$36833336D068F707,$2F08DA9177DDA93D,$74C04BF1790C0EFE,
$5E68A2355B93CAE6,$2C5E9DEB57EF4743,$5FEA21EA9E7557E3,$66C1A2A1A60CD889,$74F5D05C10CAB243,$2B4F6451CC1D45EC,$004456AF10F5FB53,$33598080CE64A656,
$7FBA195410E5CA30,$70CB6AF7C2D5BCF0,$539BB9C3A48DB6CF,$24EC0132764CA04B,$6328E230E3E2B3FB,$57277707199B8175,$7C45D833AFF07862,$32AB0EDB696703D3,
$63273522064480CA,$634A1D250E7A8D6B,$190E714FADA5156E,$4AE7D6A36EB5DBCB,$4E9D2827355FC492,$7A4C10EC2158C4A6,$2102AE466EBB1148,$177E00F9FC32F791,
$7EBA726D8C94094B,$2785338347F2BA08,$01A1549FD6573DA5,$4F3145DE0ADD4289,$61B32AA868338AE9,$400F3B30F32F543C,$10AF9B4B85ACFD63,$268A9649E9579A1B
));

     MatZobr : TmatZobr =
(($ED11A5AE,$4E635706,$0CE35DB2,$E04FD28A,$486220F6,$7AA0144B,$B59C753B,$47DB6DFA,
$8AE4CAB7,$9EA2A137,$BD62F9BE),($77FFB756,$8B6DFD91,$0B891122,$60488296,$FB8693B1,
$42B6B444,$6D220477,$6CDBA0BC,$B7E4B564,$D3989F5C,$FF27B87A),($A232499D,$9B53BF4C,
$A037EC4B,$D74A26F8,$369E5929,$9F678486,$1655E713,$8AAAD1A6,$C61AF435,$31FDE253,
$DCDD2375),($DD4243D3,$2795D7BA,$9EACBAB4,$79832D6F,$18F1BCE0,$DA5B5EAC,$9FE059B3,
$77E214B9,$5BB8AF81,$4CE07539,$E1BA6845),($089F3E24,$A0502136,$67875436,$5CD11E1D,
$CE14D435,$2DEBDF54,$AE6E41AC,$5674436B,$40DE8F7F,$62639A6F,$31985B25),($9CDA5A69,
$79EE1E28,$D371E7FE,$80348EEE,$D7BED90E,$F38566ED,$36A77F32,$43C5454A,$59EF083D,
$7F4E3A96,$42599C9F),($C8C980DB,$8CD86481,$C8C0E727,$C964E287,$EDFC3D32,$6B6EC789,
$38DEE0F2,$ECD8A246,$2FFCC786,$FC9E2AB3,$02010B1A),($C35CC517,$1C9DEB60,$F91E219C,
$A7E21C1F,$1E08244D,$380F17E3,$C204BCEE,$6360DD42,$3D73816F,$B9C5EF12,$E55290AF
),($F6D3DA33,$C677FEF4,$AC4EA3E9,$E21C11CE,$F76831CB,$D252BBF9,$17EB2CFC,$EFF8D46E,
$64118FAB,$8E04AF61,$F7AE1685),($B5F30A5D,$FDD36036,$D8307C1B,$8313479E,$D61164F1,
$999D853C,$F5CF433F,$EF4BF43A,$03268AF0,$920192B8,$298C459A),($60D13010,$4B5508FD,
$E7E492AA,$8CCFC520,$126A432D,$D8802991,$DC5191E2,$670B31F2,$06CB334D,$EF0F71E0,
$29756D32));

    CastleZobr:TcastleZobr=
($8BCBAC2A1DD26D4C,$905651EC8F0BB6ED,$4387C136D6E4BD0E,$918B9ADD62AB9F26,
$5AFC7FC13B5AE497,$57E560CD235E09BB,$D8A4DA42F2432E50,$646958EA5CFD0FB3,
$E472D1179517A9D8,$745509B22250E649,$EBD9E7B267589891,$81803078F11DFE67,
$D65DF276F72CF64B,$49EE36DAB7EA8ADD,$C4A95D7B5444BD05,$601180A27947B4C9);


  Zcolor=$5157BEEC0E5D3846;
  Zexmove=$547210051364271A;
  EntrySize=4;
  HashValueMax=32700;
  HashLower=1;
  HashUpper=2;
  HashExact=3;
VAR
   TT : TTT;

Function CalcKeyFull(var Board:Tboard) : Tkey;
Function CalcPawnKeyFull(var Board:Tboard):TpawnKey;
Function CalcMatKeyFull(var Board:Tboard):TMatKey;
Procedure ClearHash(var H:TTT;HashSize:integer);
Procedure NewAge;
Procedure HashStore(var Board:TBoard;value:integer;depth:integer;typ:integer;move:Tmove;Age:integer;emove:tmove;var StaticEval:integer);
Function HashProbe(var Board:Tboard;emove:Tmove):integer;
Function ValueToTT(value:integer;ply:integer):integer;
Function ValueFromTT(value:integer;ply:integer):integer;
Procedure SetHash(var TT:TTT;Size:integer);

implementation
uses BitBoards,Evaluation;

Function CalcKeyFull(var Board:Tboard) : Tkey;
// Функция возвращает хеш ключ позиции
var
   temp  : Tbitboard;
   res   : Tkey;
   sq    : TSquare;
   piese : Tpiese;
  begin
    res:=0;
    temp:=Board.AllPieses;
    while temp<>0 do
      begin
       sq:=BitScanForward(temp);
       piese:=Board.Pos[sq];
       res:=res xor PieseZobr[piese,sq];
       temp:=temp and NotOnlyR00[sq];
      end;
    if Board.EnnPassSQ>=a1 then res:=res xor PieseZobr[0,Board.EnnPassSQ];
    res:=res xor CastleZobr[Board.Castle];
    if Board.color=black then res:=res xor ZColor;
    Result:=res;
  end;
Function CalcPawnKeyFull(var Board:Tboard):TpawnKey;
// Функция возвращает пешечный хеш ключ позиции.
var
   temp  : Tbitboard;
   res   : TPawnKey;
   sq    : TSquare;
   piese : TPiese;
  begin
    res:=0;
    temp:=Board.Pieses[WhitePawn] or Board.Pieses[BlackPawn];
    while temp<>0 do
      begin
       sq:=BitScanForward(temp);
       piese:=Board.Pos[sq];
         case piese of
            Whitepawn : res:=res xor PawnZobr[white,sq];
            Blackpawn : res:=res xor PawnZobr[black,sq];
         end;
        temp:=temp and NotOnlyR00[sq];
      end;
    Result:=res;
  end;
Function CalcMatKeyFull(var Board:Tboard):TMatKey;
// Функция возвращает материальный хеш ключ позиции.
var
   i,count:integer;
   res:TmatKey;
 begin
    res:=0;
    for i:=BlackQueen to WhiteQueen do
     if i<>Empty then
      begin
         count:=BitCount(Board.Pieses[i]);
         res:=res xor MatZobr[i,count];
      end;
    Result:=res;
 end;
Procedure ClearHash(var H:TTT;HashSize:integer);
var
   i:integer;
begin
  for i:=0 to HashSize*EntrySize-1 do
    begin
      H[i].Key:=0;
      H[i].data1:=0;
      H[i].data2:=0;
    end;
   game.HashAge:=0;  
end;
Procedure NewAge;
begin
  inc(game.hashAge);
  if game.hashAge>=31 then game.hashAge:=0;
end;
Procedure HashStore(var Board:TBoard;value:integer;depth:integer;typ:integer;move:Tmove;Age:integer;emove:tmove;var StaticEval:integer);
var
   index,i,d1,d2,t,hashscore,max,idx,d:integer;
   Key:Tkey;
   //htyp,hvalue,hdepth,hmove,hashindex:integer;
begin
  max:=-65535;
  idx:=-1;
  Key:=Board.Key;
  if (emove<>movenone) then key:=key xor ZexMove;
  index:=(Key and HashMask)*EntrySize;
  for i:=0 to  EntrySize-1 do
    begin
      if TT[index+i].Key=Key then
        begin
          t:=TT[index+i].data2 and 65535;
          d:=(StaticEval+HashValueMax) shl 16;
          TT[index+i].data2:=d or t;
          if move=MoveNone then move:=(TT[index+i].data1 and 65535);
          if (depth>=(TT[index+i].data2 shr 8) and 255) then
            begin
              t:=value+HashValueMax;
              d1:=(t shl 16) or move;
              d2:=Age or (depth shl 8) or (typ shl 5) or ((StaticEval+HashValueMax) shl 16);
              TT[index+i].data1:=d1;
              TT[index+i].data2:=d2;
            end;
          exit;
        end;
     // Вычисляем "оценку" имеющихся ячеек для схемы замещения. Более предпочитетльными для замещения являются "старые" записи
      // и записи с минимальной глубиной вхождения
      if age<>(TT[index+i].data2 and 31)
        then hashscore:=1024
        else hashscore:=0;
      hashscore:=hashscore-((TT[index+i].data2 shr 8) and 255);
      if hashscore>max then
        begin
          max:=hashscore;
          idx:=i;
        end;
    end;
  // Найдена предпочтительная ячейка для замещения - записываем в нее информацию по текущей позиции
  t:=value+HashValueMax;
  d1:=(t shl 16) or move;
  d2:=Age or (depth shl 8) or (typ shl 5) or ((StaticEval+HashValueMax) shl 16);
  TT[index+idx].Key:=Key;
  TT[index+idx].data1:=d1;
  TT[index+idx].data2:=d2;
 { // Проверка
  hashindex:=index+idx;
  hmove:=TT[hashindex].data1 and 65535;
  hdepth:=(TT[hashindex].data2 shr 8) and 255;
  htyp:=(TT[hashindex].data2 shr 16) and 15;
  hvalue:=(TT[hashindex].data1 shr 16) and 65535;
  hvalue:=HValue-HashValueMax;
  if (depth<>hdepth) then writeln('wrong depth');
  if (typ<>htyp) then writeln('wrong depth');
  if (hvalue<>value) then writeln('wrong depth');
  if (hmove<>move) then writeln('wrong depth');
 } 
end;

Function HashProbe(var Board:Tboard;emove:tmove):integer;
var
   res,index,i : integer;
   Key:Tkey;
begin
  res:=-1;
  Key:=Board.Key;
  if (emove<>movenone) then key:=key xor ZexMove;
  index:=(Key and HashMask)*EntrySize;
  for i:=0 to  EntrySize-1 do
   if TT[index+i].Key=Key then
    begin
      res:=index+i;
      break;
    end;
  Result:=res;  
end;

Function ValueToTT(value:integer;ply:integer):integer;
begin
  if value>=Mate-FullPly*MaxPly then result:=value+ply else
  if value<=-Mate+FullPly*MaxPly then result:=value-ply else
   result:=value;
end;
Function ValueFromTT(value:integer;ply:integer):integer;
begin
  if value>=Mate-FullPly*MaxPly then result:=value-ply else
  if value<=-Mate+FullPly*MaxPly then result:=value+ply else
   result:=value;
end;
Procedure SetHash(var TT:TTT;Size:integer);
begin
  SetLength(TT,0);
  SetLength(TT,Size*EntrySize);
  ClearHash(TT,Size);
end;
end.
