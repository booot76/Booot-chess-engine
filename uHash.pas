unit uHash;

{$IFDEF FPC}
  {$MODE Delphi}
{$ENDIF}

interface
uses uBoard,uBitBoards,SysUtils,DateUtils;
Type
  TEntry = packed record
             Key32      : cardinal;
             crc32      : cardinal;
             move       : word;
             value      : smallint;
             depth      : shortint;
             typage     : byte;      //2..7 - Age 0..1 - Typ
             steval     : smallint;
            end;
 Pentry = ^TEntry;
 TTable = packed record
            data        : array of TEntry;
            size        : int64;
            Mask        : int64;
            Age         : byte;
          end;
 TPieseZobr = array[white..black,pawn..king,a1..h8] of int64;
 TEnnPassZobr = array[a1..h8] of int64;
 TCastleZobr = array[0..15] of int64;

Const
  AgeInc=8;
  TypMask=AgeInc-1;
  AgeMask=255 and (not TypMask);

  EntrySize=4;

  HashLower=1;
  HashUpper=2;
  HashExact=3;
  HashPV=4;

  PieseZobr : TPieseZobr =
   (((-5806046825325303563,-8328424648811089562,8868758241292569811,4881366684015708417,-3790025024278790943,2357318667285771148,1606727246881709434,-5309248615317715964,1962756488991144730,8783154993359605063,7549522424143453667,-5722514236476424809,3605202650950397208,-5989525406507628003,8374841041396179619,6635474344653679202,
      7792416413078048400,2582477501334234070,6603497124130663057,1124679990303892812,-6977258949192188549,5634028748172014201,1386926345503772357,-57529053821247622,-3892863141723035122,5807779174337682510,1190712377696629398,-1429669434836725674,-4275908352510474558,-5405355224688458279,-417626725435247717,-3096998154632125052,
     -1111002561229785011,1911102666885612004,6360505958144285098,-6515293280830491923,-1704525751022484058,-1900843239069269643,4896110049814136539,-1809860895991356745,3444796087345956869,-1156415566237400109,1709320829671696260,8014221648532137290,-2012503785619612961,4066234808617993860,2256632690704654909,1306917620979376460,
     7745718313689041901,-7837751972485024431,5167681407849940957,5795019174012576677,2715152488293042980,6468024635543509567,-3519662455693687941,584927748775432059,1980593122081200829,1923773750911208854,-784812363132892563,2632030808297999925,-5835381071645638866,5329303151822939613,-6174941279066846134,5633592684959154043),
     (5449662663861432110,-1102196175804225573,4664395033852682987,-7286593172543313613,1579947112223785908,6727478464813381271,1989786619166753380,4443021081323595652,-7222394096066254856,-3199900196316642472,6876934601603033359,3950185542113058006,-8916837146132559505,4346408733882006949,-6778538772356313215,281154443318665679,
     4593158659568453586,-3047971105756642492,-7345250776568080238,5742572941785216343,-5199932668243663593,-2077416671478198210,-3452714855509868199,-6755510278578557804,-43431605800290955,6728715389303254744,5581451741255930156,1214226000500761325,182024463602880355,-6754595731031136358,5543254995702106531,-1293769227385886198,
     3932702360696748952,2664145148545560907,-1551909078993676652,8764101232499046865,5343659856993903883,2157186247676715250,-3220783328119620073,-8024506772043063190,-3089698311575025420,4238141892746615254,-726151914049908605,6727911329552593467,618368496839894729,5658824044082822526,3606967492910291054,531024805300959723,
     6837109152447000640,90798296706440113,625572700202715824,7164257005105162338,5450395578040809810,-9193904556730883467,5478384442360690272,-6659540569290963770,-1462565640816531403,3361300805428874771,-3489010963124669228,513831853254777982,-5391858383095683743,6045108356717156624,1734089243462998436,-8458092440854858958),
     (2840206734555401099,-3652021060490040268,826284655239635623,-7505963616805358903,8865471382758135723,-4803610757884146042,-6844703020762683405,-5344708957339395224,5899918439429593337,4296125941890913613,-7985247690242700320,4098696539941188472,7425790944781820139,366253177284531216,411123077500889860,-969505416717748320,
     4533760335939597112,3163152591008697494,5301073251400944695,-2189757006843786554,-2948210532940761641,-4072766924781101338,8718632556126163088,-2153197238415661551,6225844176560300287,-6593873627427129018,3564671665936261989,6728045540135209193,-4830019250793058521,-802863235650353089,4736046734138010190,-439792918173964044,
    -7771352170201248505,-18228464600095082,6466078760662922530,5440078715703730713,-7022221988270995051,-3345114547938587309,-4991075678890070537,-8991489567530703232,-8645223268758911481,-1440507250669075522,-1786787604132460251,2258612451242258063,-7661892026592451114,-722913250350575780,5971568809227531587,-7247033296334558994,
    6186328336707354296,7754814050341774325,1349197821771942695,2323909203269659267,5777159008539510948,5647924233210467215,-8287817808050831895,3737485594698505845,-5369037150151340590,-3104341575248855437,2963702508064115424,7606757219644241452,1146400764276185783,1956905661009527591,-7001305381852766,1288632626870278478),
    (-952577120335761908,-3296061827140899215,-8410760946030035962,-1540243858983627325,-6145665830025467705,-1106523013554197671,6231839893710716453,-3543857177574469711,-1328700649922068962,7060145699129324327,-5908442884776561068,7405419191279219071,-8471770411850128502,-5247028700665184928,5733020352796452139,-2881130354165670955,
    1850159277729956034,-2996083555037663284,1884074479816914304,8456271693854463385,-5986999136970301509,-6116647130446737806,-4756863202150437781,7985629381477596146,9149776123810438317,-3031406317825954919,7822491102442035523,-9099580008352714168,-6629920553583684080,6686061576264243143,-8603595153860672098,-6299412883614526911,
    -5094303112329749350,6546663732401705413,6203381763966231892,-3804678939148346427,-7672745295269534910,-5725345183053662567,-6179110629050481028,7971591147522008314,-540785737702838465,-5510244037189996151,-7237211354990771860,7288725439282383432,4275859139179251720,-2397702553202430947,3586374466605115580,9101887815463558741,
    28750752055224148,-9057355366090097124,1573931649552742722,3956939152730872328,-2068619380377474790,8335679214215191949,4756774958421969430,7564918531890891912,2944423461868026770,-4790190019782209865,-5637759662714389361,-300843759929980099,8014208293216767794,5746532540427883553,1283906033693338691,-7783782436630961714),
    (6753148570620937905,-5798662102309937518,8082402733729439498,4844815082305061409,6122705539130173190,-6393190444569789167,-1438697903541996293,4081514256157045853,2221174627426338664,-672747518288098076,7342723903586506860,8105728377416976105,-7033632625748049586,187556159420426644,3422527934820658677,7228680065246346861,
    -9222269633770446737,-8843560584601051930,-4913846669933886355,-4977172730092599856,-1634742462401097021,4473343141501243106,5696686438465848554,-550962561271800264,2964302088668600448,-6795251878607718961,-5856177653784403260,3306956466045406988,7464439536000447517,-8499471958388685260,-3346526164608103534,-6190510151528065549,
    6199224415601465937,-1853110389937020200,-8105469608428759254,-6288615722715998507,-2373098136960081389,7698894768012610754,5896949297127110564,206340632009411544,-2986910473011301222,4710769026091750200,-4395304211625399978,-2393400365133138588,-6227054213337498275,-5129324545367686205,9132940474384032472,6919674878861462047,
    1046776837056829972,-769821375193982424,-4464569447303314175,6297595830576948977,-5405665054345737547,-6895264732426620816,1954330954921757415,-941866876423520512,-734397430697959050,-7461151108972908832,1835184082567199202,7920173422513179571,-8999523492242050352,-6797098709585495040,-157813849431666295,-4546756060446294862),
    (1746577577844426105,1522015585435643031,7647943903365757874,5885713983962736611,3012472215505912425,-7981494095931411540,1272828095459916917,-6680245319246317203,-7662106400216390443,-6220434746771713402,7557164948813947433,434998988234810296,5975016230129691190,-7540235526381320021,6161764787163018596,5148275182711869290,
    2444773688784093761,-1696878063410281500,-2410571225671948034,7085235344462154603,4344778792691908335,3485553232256471094,-2579394716632708594,3365608495658630369,351259542567650422,-5203291341887944726,-6342753053305671702,1289541692905656115,-5204489306806191795,3215580312856249221,-3704678431887365079,-5878272799167912951,
    1898142696149382699,5911875147046144463,-5330767902882661724,-7775793790870879415,3112375851514033672,-5731070902232203313,7026016386494853488,-1158096597497820389,-3301759994661370343,5011725688120121548,974027236572066021,4341098070999654373,-8041206105480153641,3763776782494844493,-1600102351265180775,-1111553146846372786,
    3475218518753937144,8406328309882529816,-4084749472339878300,3582098555913011518,8448985375154494835,-8915763094439265226,-4013030867846795171,-9100751670950386213,-3722817905716367489,1564612632907009772,1171446035056194266,8058439578849027980,-318906023294618221,-4545688005980132669,8350239470924777843,5235086632419400185)),
    ((-3290171143665722778,-5544834993485232000,2967137097243263486,-4182735201199229175,-2793965366626866448,6811247945904127787,8601511297029833876,-4700272875075236127,150319308743706214,3099765914336441355,7416999223085007753,-2924650016972933142,6343369917611953729,2697614845708634791,8186105795408391031,3560336898889121483,
    -5806542545758661065,-5767968129543269178,3628712739644429107,1985382651389580906,6186376559645578303,3602383576090395246,1544319294036700117,-4474900740243732498,-4453976620317421424,-4019586880718024216,598139789463285939,-2469423889205681473,4938055599779911074,-825768976223256647,3004911424231446373,7320262566280604803,
    -5315710786368036822,5630251155226900138,8762580299802607554,4415061382161551649,3019051551442964257,3561209337855737792,-8557097421020716064,-1886345664004500799,-7249677937796377667,8074744908189725251,3106720829435004951,3281133030238009801,-6931503122345401995,70232229375632314,2516671964025121534,-2309677306660305695,
    1550013636979990016,-5740556969667061780,-3050107627180280469,8492284808761923823,-3163344312254377643,-3491003940486008608,-463191541999277450,-4229898367371677414,6660718033269020075,-1923986498700435747,5052582195503650677,-5650670405337313590,-8602052557480147078,6736983948874322025,2596415335956169729,-2649342071181661787),
    (4324458411136775543,4129086239683142221,6723227178858570222,5768049067666808723,1384667331391213723,-4673359060169027698,-3664017482661708458,4257087953527022778,1447082553297296412,3075922331253481844,1157601603394874510,-7738125231892941951,6753547387403410801,6690301033224314759,3730644370165317678,-3300604321272136560,
    -2847073829418103727,-8373867398775275636,7440224532235334412,-7594048891472357683,-1874292792388582733,-940790945707027061,-6143822179742361024,7055246864118296415,1230712546423024847,-9009608030148131894,9202157239379137825,4711615729052514734,-4765757535393548006,-7942245282672858414,-7429970205011460795,9193163802444537697,
    -2760217068361217971,-8462888959081571991,-8483538266501966204,6073425037481767005,-8417977622270173858,-7083222207077876587,8724059397634375412,-7743031681925770549,-2149108301665006204,8134638626227031967,-3762411501700047122,7108541996899955474,-8662288907666509770,-3527276282592392180,-2728387242846463738,-2439322706405411880,
    7952999671757786923,6365129879986248100,-7126113464054433258,-3182933128319066620,-9113228133614578085,3614950569266527854,6839505284436076851,7906912344827662526,6205404156676932603,-5244829553090441551,7714530403743078325,-2078856451290140308,-2720381541066155900,2838703554808143092,-4736885824361074382,2928257916096158645),
    (379660008375551660,6332691563203111422,-5295999469138113662,-6919202037753196159,-8662154449339178134,7140010517586056405,-4394613739929004356,-4019532025859200266,8910865255577310709,6390153463273949890,1461091053333187894,-1322744751572023684,1440642067292276676,-1327365028202842294,5477780937114919816,-2752148047795619655,
    5558554719096050831,3167261604621530165,3258494612755822729,-8971503279077442412,-7154547358457513397,2537867151182100875,5485043895034332495,-4701499003135843531,-6805760657473828559,-7490672880930304623,-4742351366659322574,-1378145694785797118,-3186784195755895881,-5451166710129232689,-3879897349543342647,-6023912730114347870,
    3799998731459927700,-5238682158580014580,-7493235028695896342,-8565609422891757315,-69004220280827713,-6534939545485400498,-2235651968060312915,-6046317166943536326,6235886753566122863,-572655322229350178,-6950969326856608408,-8387762742162490434,-551444497853902308,5652807251636989761,-4653442478971974221,-7265395944063280846,
    -1527192565037233541,2064994130621439296,-3630929490054505371,-315255163689287555,3280889920414817413,6636912361860044000,-6316591051641807724,3097466852593005765,7593077935940627056,4284483904008113769,3392384066087855000,-5436643317908914319,-6885262162177206093,-3557284337567088541,-967826530004090616,-2242919652508213207),
    (-2442728867631366651,-4698925603727241325,-1961116868084109638,7330555635006078163,-1806130634357435555,-406193632711246080,645378890084810950,1598167269816963478,-1670827689627524110,7278115662369677299,2562560979213194627,-7890159230521581350,3086772903688191292,-8672419941463129614,7662890390432384391,-558637920119430331,
    -4801589029704311055,4644049705407685315,3766486374020436906,-7911324159453841473,3026605916531714823,8274014223024578159,-6227477227033977598,-8616275313297026194,2565185313134368183,-5227688026751164613,8340221065176713448,-8056870672107753031,3910350499983086968,882278685628861871,7890504884810660080,-7202103998392023992,
    8600592973657101055,-8908497635688087406,5968301961737287924,-8373460432341638399,3853476669379402052,-558567796076811029,8139375597198864137,-2560264279224484852,-6306343439499229825,-5365017982179912191,6223166317554830215,6367544440492639183,-6810902043870398683,3399395110326123867,-9022555917402998524,-4105215110385949455,
    4238581438870831087,-5958000842126552384,1671945071721335896,-7115769019086524326,-8638540457751653421,-188899243600403402,-8802617512933935975,-5975834414099231440,5059677223778187528,2452021738812345862,4768543621104134944,-3041912054488897317,-8414293982246946811,230013335431097013,8138968117497078658,-5481037288381847807),
    (8539410738115595138,2163942192531538699,-7483775672490820714,5859490299087163785,-2258067466129534860,3816328576284769808,5690772334421306228,-3100620397615626085,831992663478629908,-24253227330989815,-1302050787721661069,3688494355672609437,5927596257152921048,-2663307718690263171,4521347607112767018,-2484699048363742154,
    -2798079101451609225,8738334383605988149,3199293213752685679,8268607435282856014,4458360794407699688,-7943718909714353097,8295065985696551258,7993036892929290251,5132181278713184866,-7984715632072234806,5792042756619712577,-2642158777232100651,-7686004115572904356,5294028735845066100,3669585839244373692,-106035121098205614,
    5876659064543614350,-6789934951839374083,7690266453741675682,885809836080535145,-2414315634184165651,5080986451756236909,-2809252651988720631,-3049779616750336702,-8646372893608582222,6439106651421564681,-6897836355323133623,8716913237279816515,3688764450126352211,2394606257064388185,-3154171548798285063,1276313200939960084,
    1038671011790774151,-5022580491008546268,3016759219836271087,7544669813470092699,4703524875761200197,-4181209721340273551,-6383199222445186749,-6630591025272894977,-7160267536335396924,1940465851980348806,6078383950082006603,-659850716808651352,5374641953724130940,8436534400751373292,-1627308128618575713,5896305438451540028),
    (9115272587445362467,2709081343219659880,-9181856931653508586,1349439430218153891,2664154018934098607,-4403229102186905085,4977222957937280711,-5433776068862427133,-7792605831772079015,-2835960150735319550,2549374720413293832,9202128298157796291,4198487008976488855,-7511397539418673171,8735553025722090864,4151506043199538059,
    5804459389439343136,-8761253561792959093,-4207991448849347880,-3090103231678042559,-8623626359972497428,3460274855384312547,6393715855051608661,2467761403755702540,-4868834933788836048,-3080199691847361988,295232666964347710,9101364879721248596,-6846703538737967515,2019176859717659677,-3860535539832627412,-8947075282062617920,
    8310597442685752896,-4647619230038950068,-8092248137779486220,-4999449280726377675,-6190543655243830854,4619379554280345810,-3952392211937361491,5167255779773581020,-6549671156696879607,-7817831724715611148,3261066802679789231,-7104844416169455076,6736467266693663396,-3125902938996450758,7187648466675544977,3114563884089438107,
    1555476592288880963,-892806997665868948,-5360267756669479638,1007948072146516032,649535621957719515,7342662837888462223,-4822679815318891888,-4631428086752928973,2062669647147519653,-3015090341584696085,1556998459334913307,-4054802948601377318,-8176567624687889385,-3149090325435788282,861363335427874913,7677457864890678236)));
  EnnPassZobr : TEnnPassZobr =
    (-6480612858987140889,-8827851803986013271,5627039788699013690,6482803479850039073,7195064290078257678,6063714889901046490,-7259894353782340931,7280537736099489743,3584521336896186050,-6921067276599736609,8351649434954529856,2885835998952127566,-7865179946666114949,7912736587898827585,-3906144025430523045,-4860547400034215612,
     -3205624220132857106,1721455934467844549,-5772685708832536859,7588713887740660120,-5090492517900078060,-172117747808701837,751435752371097588,5937887156388048498,3690155292292070434,3721234688098378642,4531628276233548256,2962049635651088184,663627128957855121,3740123474338025897,-2017177334582379969,-2596361452576069231,
     -8308961084336012009,-8246175580406726785,8196646768864157930,5099906733808296293,5207193040471855531,-7708013607214133733,-1054668184176969739,-2120527277777096485,-5780300384635841403,1439773987532205252,-5957955986703672390,8477878578268600408,-3433263137808574182,-480576485695141632,-2208465067695938866,-4354525229694136698,
     24373065950141731,666694536371371672,7669445717411401225,4402647314970062921,-8118389272752521067,-8275394823453407343,8560778197057812609,-5743533667202600758,8517119577512441257,267472117411884083,3886787591723911054,-544649794867369617,507121452161986773,-3397997805831326971,-8605542253557802297,-5901923644207699488);
  CastleZobr : TCastleZobr =
    (-7118538147542722352,-1317712728219774770,-5715480252538913790,-2951786757321480189,5571164115614971537,-7440952713580390251,108283423676665687,-7615510769587277825,-7694739096645720752,402825833641978785,-8106032890858962147,-2578263574059658180,865176943957525122,950136959318387064,-2275161975432921110,1606877746442509664);


  ZColor = 1300814577812659680;

var
  TTGlobal              : TTable;   // Глобальный хеш движка

Function ValueToTT(value:integer;ply:integer):integer;
Function ValueFromTT(value:integer;ply:integer):integer;
Function CalcPosKey(var Board:TBoard):int64;
Function CalcPawnKey(var Board:TBoard):int64;
Function CalcNonPawnKey(side:integer;var Board:TBoard):int64;
Procedure InitTT(var TT:TTable;SizeMB:integer);
Procedure ClearHash(var TT:TTable;cpus:integer);
Procedure multiclear(ThreadID:integer);
Function HashProbe(var TT:TTable;Key : int64):int64;
Procedure HashStore(var TT:TTable;Key:int64;value:integer;depth:integer;typ:integer;move:integer;steval:integer;hashpv:boolean);
Function FindPonder(var TT:TTable;RootMove:integer;var Board:TBoard):integer;

implementation
uses uSearch,uAttacks,uThread;

Function GetAgeDistance(Age:integer;typage:integer):integer; inline;
var
   res : integer;
begin
  res:=Age-(typage and AgeMask); // Получилось расстояние =  (AgeNow-hashage)*AgeInc;
  if res<0 then res:=res+256; // Если перешли через 0
  Result:=res;
end;
Procedure HashSave(var TT:TTable;index:int64;Key32:cardinal;value:integer;depth:integer;typ:integer;move:integer;steval:integer;hashpv:boolean);
var
  hpvint:integer;
begin
  if hashpv
    then hpvint:=1
    else hpvint:=0;
  If (move<>0) or  (TT.data[index].Key32<>(Key32 xor TT.data[index].crc32)) then TT.data[index].move:=move;
  If (typ=HashExact) or (TT.data[index].Key32<>(Key32 xor TT.data[index].crc32)) or (GetAgeDistance(TT.Age,TT.data[index].typage)<>0) or (depth+4+2*hpvint>TT.data[index].depth)   then
    begin
     TT.data[index].value:=value;
     TT.data[index].steval:=steval;
     TT.data[index].depth:=depth;
     TT.data[index].typage:=TT.Age or typ or (hpvint shl 2);
     TT.data[index].crc32:=((steval+32768) shl 16) or (value+32768);
     TT.data[index].Key32:=Key32  xor TT.data[index].crc32;
    end;
end;
Function ValueToTT(value:integer;ply:integer):integer;inline;
begin
  if value>=WinScore  then result:=value+ply else
  if (value<>-inf) and (value<=-WinScore) then result:=value-ply else
   result:=value;
end;
Function ValueFromTT(value:integer;ply:integer):integer; inline;
begin
  if value>=WinScore  then result:=value-ply else
  if (value<>-inf) and (value<=-WinScore) then result:=value+ply else
   result:=value;
end;
Function ScoreEntry(Age:integer;typage:integer;depth:integer):integer;inline;
begin
  result:=depth-GetAgeDistance(age,typage);
end;

Procedure InitTT(var TT:TTable;SizeMB:integer);
// На входе - ОБЩЕЕ количество мегабайт кеша, полученного от оболочки
begin
  TT.Size:=SizeMb;
  TT.Size:=(TT.Size * 1024 * 1024) div 16;//  Ячейка весит 16 байт
  TT.Mask:=(TT.Size div EntrySize)-1;
  SetLength(TT.data,0);
  SetLength(TT.data,TT.Size);

end;

Procedure multiclear(ThreadID:integer);
var
  i : int64;
  ind:PEntry;
begin
  ind:=Threads[threadid].hashstart;
  for i:=0 to Threads[threadid].hashcnt-1 do
    begin
      ind^.key32:=0;
      ind^.crc32:=0;
      ind^.move:=0;
      ind^.value:=0;
      ind^.depth:=0;
      ind^.typage:=0;
      ind^.steval:=0;
      inc(ind,1);
    end;
end;
Procedure ClearHash(var TT:TTable;cpus:integer);
var
  i : integer;
  part : int64;
begin
// game.starttime:=now;
 part:=TT.size div cpus;
  for i:=1 to cpus do
    begin
      Threads[i].hashstart:=@TT.data[(i-1)*part];
      Threads[i].clrflag:=true;
      Threads[i].hashcnt:=part;
      Threads[i].haswork:=true;
    end;
 Threads[1].idle:=false;  // Маркер работы 1-го потока
 IdleEvent.SetEvent;
 while not  Threads[1].idle do; // Убеждаемся что остановился первый
 if cpus>1 then
   While isThreadIdle do;    // Убеждаемся что остановились остальные
 TT.Age:=0;
// writeln(millisecondsbetween(game.StartTime,now));
 IdleEvent.ReSetEvent;
end;


Function CalcPosKey(var Board:TBoard):int64;
// Вычисляет 64-битный хеш позиции. Медленная функция используется при начальной  установке доски и для дебага.
var
  Res,temp:int64;
  sq,piese,piesetyp,color : integer;
begin
 res:=0;
 temp:=Board.AllPieses;
 while temp<>0 do
   begin
     sq:=BitScanForward(temp);
     piese:=Board.Pos[sq];
     pieseTyp:=TypOfPiese[piese];
     color:=PieseColor[piese];
     res:=res xor PieseZobr[color,piesetyp,sq];
     temp:=temp and (temp-1);
   end;
 if Board.EnPassSq<>NonSq then res:=res xor EnnPassZobr[Board.EnPassSq];
 res:=res xor CastleZobr[Board.CastleRights];
 if Board.SideToMove=black then res:=res xor ZColor;
 Result:=res;
end;
Function CalcPawnKey(var Board:TBoard):int64;
// Вычисляет 64-битный хеш пешек. Медленная функция используется при начальной  установке доски и для дебага.
var
  Res,temp:int64;
  sq,color,piese : integer;
begin
 res:=0;
 temp:=Board.Pieses[pawn];
 while temp<>0 do
   begin
     sq:=BitScanForward(temp);
     piese:=Board.Pos[sq];
     color:=PieseColor[piese];
     res:=res xor PieseZobr[color,pawn,sq];
     temp:=temp and (temp-1);
   end;
 Result:=res;
end;
Function CalcNonPawnKey(side:integer;var Board:TBoard):int64;
// Вычисляет 64-битный хеш беспешечного материала. Медленная функция используется при начальной  установке доски и для дебага.
var
  Res,temp:int64;
  sq,piese,piesetyp: integer;
begin
 res:=0;
 temp:=Board.AllPieses and (not Board.Pieses[pawn]) and (Board.Occupancy[side]);
 while temp<>0 do
   begin
     sq:=BitScanForward(temp);
     piese:=Board.Pos[sq];
     pieseTyp:=TypOfPiese[piese];
     res:=res xor PieseZobr[side,piesetyp,sq];
     temp:=temp and (temp-1);
   end;
 Result:=res;
end;
Function HashProbe(var TT:TTable;Key : int64):int64;
var
  Index : int64;
  i : integer;
  Key32 : cardinal;
begin
  Result:=-1;
  Index:=(Key and TT.Mask) * EntrySize;
  Key32:=(Key shr 32);
  for i:=0 to EntrySize-1 do
    if (TT.data[index+i].Key32=(Key32 xor TT.data[index+i].crc32)) and (TT.data[index+i].typage<>0) then
      begin
        Result:=index+i;
        // Обновляем свежесть  хеша
        TT.data[index+i].typage:=TT.Age or (TT.data[index+i].typage and TypMask);
        exit;
      end;
end;



Procedure HashStore(var TT:TTable;Key:int64;value:integer;depth:integer;typ:integer;move:integer;steval:integer;hashpv:boolean);
var
   i:integer;
   rep,index:int64;
   Key32 : cardinal;
begin
  index:=(Key and TT.Mask) * EntrySize;
  rep:=index;
  Key32:=(Key shr 32);
  for i:=0 to  EntrySize-1 do
    begin
      if  (TT.data[index+i].Key32=(Key32 xor TT.data[index+i].crc32))  then // Замещаем уже существующую запись о позиции
        begin
          HashSave(TT,(index+i),key32,value,depth,typ,move,steval,hashpv);
          exit;
        end;
      // Ищем наименее ценную ячейку в букете для замещения
      if (i>0) and (ScoreEntry(TT.Age,TT.data[rep].typage,TT.data[rep].depth)>ScoreEntry(TT.Age,TT.data[index+i].typage,TT.data[index+i].depth)) then rep:=index+i;
    end;
  // Найдена предпочтительная ячейка для замещения - записываем в нее информацию по текущей позиции
  HashSave(TT,rep,key32,value,depth,typ,move,steval,hashpv);
end;

Function FindPonder(var TT:TTable;RootMove:integer;var Board:TBoard):integer;
var
  CheckInfo,CheckInfo1 :TCheckInfo;
  isCheck         : boolean;
  Undo            : TUndo;
  HashIndex       : int64;
  Ponder          : integer;
begin
  Ponder:=0;
  FillCheckInfo(CheckInfo,Board);
  SetUndo(Board,Undo);
  isCheck:=isMoveCheck(Rootmove,CheckInfo,Board);
  MakeMove(Rootmove,Board,Undo,isCheck);
  HashIndex:=HAshProbe(TT,Board.Key);
  If HashIndex>=0 then
    begin
      Ponder:=TT.data[HashIndex].move;
      If Ponder<>0 then
        begin
         FillCheckInfo(CheckInfo1,Board);
         if (not isLegal(Ponder,CheckInfo1.Pinned,Board)) then Ponder:=0;
        end;
    end;
  UnMakeMove(RootMove,Board,Undo);
  Result:=Ponder;
end;

end.
